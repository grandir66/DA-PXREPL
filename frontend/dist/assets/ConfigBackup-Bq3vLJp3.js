import{y,d as N,r as k,h as U,o as O,c as i,a as e,e as b,t as l,n as h,m,q as _,w as I,F as D,b as E,f as n,_ as j}from"./index-CYXbFCAl.js";const C={listBackups(){return y.get("/config-backup/available")},getSystemInfo(){return y.get("/config-backup/info")},createBackup(r={}){const o=new URLSearchParams;return r.include_database!==void 0&&o.append("include_database",String(r.include_database)),r.include_ssh_keys!==void 0&&o.append("include_ssh_keys",String(r.include_ssh_keys)),r.include_certificates!==void 0&&o.append("include_certificates",String(r.include_certificates)),r.include_config!==void 0&&o.append("include_config",String(r.include_config)),y.post(`/config-backup/export?${o.toString()}`)},async downloadBackup(r){return y.get(`/config-backup/download/${r}`,{responseType:"blob"})},getDownloadUrl(r){const o=localStorage.getItem("access_token");return`${y.defaults.baseURL}/config-backup/download/${r}?token=${o}`},async restoreBackup(r,o={}){const v=new FormData;return v.append("file",r),o.restore_database!==void 0&&v.append("restore_database",String(o.restore_database)),o.restore_ssh_keys!==void 0&&v.append("restore_ssh_keys",String(o.restore_ssh_keys)),o.restore_certificates!==void 0&&v.append("restore_certificates",String(o.restore_certificates)),o.restore_config!==void 0&&v.append("restore_config",String(o.restore_config)),y.post("/config-backup/restore",v)},deleteBackup(r){return y.delete(`/config-backup/delete/${r}`)}},q={class:"config-backup-page"},P={class:"card info-card"},G={class:"card-header"},K=["disabled"],J={class:"card-body"},Q={key:0,class:"system-info-grid"},W={class:"info-item"},X={class:"details"},Y={class:"value"},Z={class:"info-item"},ee={class:"details"},se={class:"value"},te={class:"details"},ae={class:"value"},ie={class:"details"},ne={class:"value"},oe={class:"details"},le={class:"value"},re={class:"details"},de={class:"value"},ce={key:1,class:"text-center p-4"},ue={class:"card export-card"},pe={class:"card-body"},fe={class:"options-grid"},ve={class:"option-item"},be={class:"option-item"},ge={class:"option-item"},ke={class:"option-item"},me={class:"actions mt-4"},_e=["disabled"],ye={class:"card import-card"},he={class:"card-body"},Ce={key:0,class:"selected-file mt-4"},we={class:"file-name"},Be={class:"file-size"},xe={key:1,class:"options-grid mt-4"},ze={class:"option-item"},Se={class:"option-item"},De={class:"option-item"},Ee={class:"option-item"},$e={key:2,class:"warning-box mt-4"},Re={key:3,class:"actions mt-4"},Ue=["disabled"],Ie={class:"card-header"},Ve={class:"card-body"},Fe={key:0,class:"restored-items"},Le={key:1,class:"warnings"},Me={class:"card backups-card"},Ae={class:"card-body"},Te={key:0,class:"text-center p-4"},He={key:1,class:"table"},Ne={class:"font-mono"},Oe={key:0,class:"badge",title:"Database"},je={key:1,class:"badge",title:"SSH"},qe={key:2,class:"badge",title:"Certificati"},Pe={key:3,class:"badge",title:"Config"},Ge=["onClick"],Ke=["onClick"],Je=N({__name:"ConfigBackup",setup(r){const o=k(!1),v=k(!1),w=k(!1),B=k(!1),d=k(null),S=k([]),u=k(null),c=k(null),V=k(null),p=U({database:!0,ssh_keys:!0,certificates:!0,config:!0}),f=U({database:!0,ssh_keys:!0,certificates:!0,config:!0}),$=async()=>{o.value=!0;try{const a=await C.getSystemInfo();d.value=a.data}catch(a){console.error("Errore caricamento info sistema:",a)}finally{o.value=!1}},x=async()=>{try{const a=await C.listBackups();S.value=a.data}catch(a){console.error("Errore caricamento backup:",a)}},F=async()=>{v.value=!0;try{const a=await C.createBackup({include_database:p.database,include_ssh_keys:p.ssh_keys,include_certificates:p.certificates,include_config:p.config});a.data.success&&(alert(`Backup creato: ${a.data.filename}
Dimensione: ${z(a.data.size)}`),x(),R(a.data.filename))}catch(a){console.error("Errore creazione backup:",a),alert("Errore durante la creazione del backup")}finally{v.value=!1}},R=async a=>{try{const s=await C.downloadBackup(a),t=window.URL.createObjectURL(new Blob([s.data])),g=document.createElement("a");g.href=t,g.setAttribute("download",a),document.body.appendChild(g),g.click(),window.URL.revokeObjectURL(t),document.body.removeChild(g)}catch(s){console.error("Errore download backup:",s),alert("Errore durante il download del backup")}},L=a=>{const s=a.target;s.files&&s.files.length>0&&(u.value=s.files[0],c.value=null)},M=a=>{B.value=!1,a.dataTransfer?.files&&a.dataTransfer.files.length>0&&(u.value=a.dataTransfer.files[0],c.value=null)},A=async()=>{if(u.value&&confirm("Sei sicuro di voler ripristinare questo backup? I dati esistenti verranno sovrascritti.")){w.value=!0,c.value=null;try{const a=await C.restoreBackup(u.value,{restore_database:f.database,restore_ssh_keys:f.ssh_keys,restore_certificates:f.certificates,restore_config:f.config});c.value=a.data,a.data.success&&(u.value=null)}catch(a){c.value={success:!1,message:a.response?.data?.detail||"Errore durante il ripristino",restored_items:[],warnings:[]}}finally{w.value=!1}}},T=async a=>{if(confirm(`Eliminare il backup ${a}?`))try{await C.deleteBackup(a),x()}catch(s){console.error("Errore eliminazione backup:",s),alert("Errore durante l'eliminazione")}},z=a=>{if(a===0)return"0 B";const s=1024,t=["B","KB","MB","GB"],g=Math.floor(Math.log(a)/Math.log(s));return parseFloat((a/Math.pow(s,g)).toFixed(2))+" "+t[g]},H=a=>{if(!a)return"";try{return new Date(a).toLocaleString("it-IT")}catch{return a}};return O(()=>{$(),x()}),(a,s)=>(n(),i("div",q,[s[46]||(s[46]=e("div",{class:"page-header"},[e("h2",null,"ğŸ’¾ Backup & Migrazione Configurazione"),e("p",{class:"text-secondary"},"Esporta/importa configurazione completa per backup o migrazione tra macchine")],-1)),e("div",P,[e("div",G,[s[12]||(s[12]=e("h3",null,"ğŸ“Š Stato Sistema",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:$,disabled:o.value}," ğŸ”„ Aggiorna ",8,K)]),e("div",J,[d.value?(n(),i("div",Q,[e("div",W,[s[14]||(s[14]=e("span",{class:"icon"},"ğŸ–¥ï¸",-1)),e("div",X,[s[13]||(s[13]=e("span",{class:"label"},"Hostname",-1)),e("span",Y,l(d.value.hostname),1)])]),e("div",Z,[s[16]||(s[16]=e("span",{class:"icon"},"ğŸ“¦",-1)),e("div",ee,[s[15]||(s[15]=e("span",{class:"label"},"Versione",-1)),e("span",se,l(d.value.version),1)])]),e("div",{class:h(["info-item",{"has-data":d.value.database.exists}])},[s[18]||(s[18]=e("span",{class:"icon"},"ğŸ—„ï¸",-1)),e("div",te,[s[17]||(s[17]=e("span",{class:"label"},"Database",-1)),e("span",ae,l(d.value.database.exists?z(d.value.database.size):"Non trovato"),1)])],2),e("div",{class:h(["info-item",{"has-data":d.value.ssh_keys.exists}])},[s[20]||(s[20]=e("span",{class:"icon"},"ğŸ”‘",-1)),e("div",ie,[s[19]||(s[19]=e("span",{class:"label"},"Chiavi SSH",-1)),e("span",ne,l(d.value.ssh_keys.files.length)+" chiave/i",1)])],2),e("div",{class:h(["info-item",{"has-data":d.value.certificates.exists}])},[s[22]||(s[22]=e("span",{class:"icon"},"ğŸ“œ",-1)),e("div",oe,[s[21]||(s[21]=e("span",{class:"label"},"Certificati",-1)),e("span",le,l(d.value.certificates.files.length)+" file",1)])],2),e("div",{class:h(["info-item",{"has-data":d.value.config.exists}])},[s[24]||(s[24]=e("span",{class:"icon"},"âš™ï¸",-1)),e("div",re,[s[23]||(s[23]=e("span",{class:"label"},"Configurazione",-1)),e("span",de,l(d.value.config.exists?"Presente":"Non trovata"),1)])],2)])):(n(),i("div",ce,[...s[25]||(s[25]=[e("span",{class:"text-secondary"},"Caricamento...",-1)])]))])]),e("div",ue,[s[31]||(s[31]=e("div",{class:"card-header"},[e("h3",null,"ğŸ“¤ Esporta Configurazione")],-1)),e("div",pe,[s[30]||(s[30]=e("p",{class:"mb-4"},"Crea un backup completo da scaricare e importare su un'altra installazione.",-1)),e("div",fe,[e("label",ve,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[0]||(s[0]=t=>p.database=t)},null,512),[[_,p.database]]),s[26]||(s[26]=e("span",{class:"option-label"},"ğŸ—„ï¸ Database (nodi, job, utenti)",-1))]),e("label",be,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[1]||(s[1]=t=>p.ssh_keys=t)},null,512),[[_,p.ssh_keys]]),s[27]||(s[27]=e("span",{class:"option-label"},"ğŸ”‘ Chiavi SSH",-1))]),e("label",ge,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[2]||(s[2]=t=>p.certificates=t)},null,512),[[_,p.certificates]]),s[28]||(s[28]=e("span",{class:"option-label"},"ğŸ“œ Certificati SSL",-1))]),e("label",ke,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[3]||(s[3]=t=>p.config=t)},null,512),[[_,p.config]]),s[29]||(s[29]=e("span",{class:"option-label"},"âš™ï¸ File configurazione",-1))])]),e("div",me,[e("button",{class:"btn btn-success",onClick:F,disabled:v.value},l(v.value?"â³ Creazione backup...":"ğŸ’¾ Crea Backup"),9,_e)])])]),e("div",ye,[s[40]||(s[40]=e("div",{class:"card-header"},[e("h3",null,"ğŸ“¥ Importa Configurazione")],-1)),e("div",he,[s[39]||(s[39]=e("p",{class:"mb-4"},"Carica un file di backup per ripristinare la configurazione.",-1)),e("div",{class:h(["upload-area",{dragging:B.value}]),onDrop:I(M,["prevent"]),onDragover:s[5]||(s[5]=I(t=>B.value=!0,["prevent"])),onDragleave:s[6]||(s[6]=t=>B.value=!1)},[e("input",{type:"file",ref_key:"fileInput",ref:V,onChange:L,accept:".tar.gz,.dapx-backup.tar.gz",hidden:""},null,544),e("div",{class:"upload-content",onClick:s[4]||(s[4]=t=>a.$refs.fileInput.click())},[...s[32]||(s[32]=[e("span",{class:"upload-icon"},"ğŸ“",-1),e("span",{class:"upload-text"},"Trascina qui il file di backup o clicca per selezionare",-1),e("span",{class:"upload-hint"},".dapx-backup.tar.gz",-1)])])],34),u.value?(n(),i("div",Ce,[s[33]||(s[33]=e("span",{class:"file-icon"},"ğŸ“¦",-1)),e("span",we,l(u.value.name),1),e("span",Be,"("+l(z(u.value.size))+")",1),e("button",{class:"btn-remove",onClick:s[7]||(s[7]=t=>u.value=null)},"âœ•")])):b("",!0),u.value?(n(),i("div",xe,[e("label",ze,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[8]||(s[8]=t=>f.database=t)},null,512),[[_,f.database]]),s[34]||(s[34]=e("span",{class:"option-label"},"ğŸ—„ï¸ Ripristina Database",-1))]),e("label",Se,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[9]||(s[9]=t=>f.ssh_keys=t)},null,512),[[_,f.ssh_keys]]),s[35]||(s[35]=e("span",{class:"option-label"},"ğŸ”‘ Ripristina Chiavi SSH",-1))]),e("label",De,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[10]||(s[10]=t=>f.certificates=t)},null,512),[[_,f.certificates]]),s[36]||(s[36]=e("span",{class:"option-label"},"ğŸ“œ Ripristina Certificati",-1))]),e("label",Ee,[m(e("input",{type:"checkbox","onUpdate:modelValue":s[11]||(s[11]=t=>f.config=t)},null,512),[[_,f.config]]),s[37]||(s[37]=e("span",{class:"option-label"},"âš™ï¸ Ripristina Configurazione",-1))])])):b("",!0),u.value?(n(),i("div",$e,[...s[38]||(s[38]=[e("strong",null,"âš ï¸ Attenzione:",-1),e("ul",null,[e("li",null,"I dati esistenti verranno sovrascritti"),e("li",null,"VerrÃ  creato un backup automatico prima del ripristino"),e("li",null,"Potrebbe essere necessario riavviare il servizio")],-1)])])):b("",!0),u.value?(n(),i("div",Re,[e("button",{class:"btn btn-warning",onClick:A,disabled:w.value},l(w.value?"â³ Ripristino in corso...":"ğŸ”„ Ripristina Backup"),9,Ue)])):b("",!0)])]),c.value?(n(),i("div",{key:0,class:h(["card result-card",c.value.success?"success":"error"])},[e("div",Ie,[e("h3",null,l(c.value.success?"âœ… Ripristino Completato":"âŒ Errore Ripristino"),1)]),e("div",Ve,[e("p",null,l(c.value.message),1),c.value.restored_items.length?(n(),i("div",Fe,[s[41]||(s[41]=e("strong",null,"Elementi ripristinati:",-1)),e("ul",null,[(n(!0),i(D,null,E(c.value.restored_items,t=>(n(),i("li",{key:t},"âœ“ "+l(t),1))),128))])])):b("",!0),c.value.warnings.length?(n(),i("div",Le,[s[42]||(s[42]=e("strong",null,"Avvisi:",-1)),e("ul",null,[(n(!0),i(D,null,E(c.value.warnings,t=>(n(),i("li",{key:t},"âš ï¸ "+l(t),1))),128))])])):b("",!0)])],2)):b("",!0),e("div",Me,[e("div",{class:"card-header"},[s[43]||(s[43]=e("h3",null,"ğŸ“‹ Backup Disponibili",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:x},"ğŸ”„ Aggiorna")]),e("div",Ae,[S.value.length===0?(n(),i("div",Te,[...s[44]||(s[44]=[e("span",{class:"text-secondary"},"Nessun backup disponibile",-1)])])):(n(),i("table",He,[s[45]||(s[45]=e("thead",null,[e("tr",null,[e("th",null,"File"),e("th",null,"Data"),e("th",null,"Dimensione"),e("th",null,"Origine"),e("th",null,"Contenuto"),e("th",null,"Azioni")])],-1)),e("tbody",null,[(n(!0),i(D,null,E(S.value,t=>(n(),i("tr",{key:t.filename},[e("td",Ne,l(t.filename),1),e("td",null,l(H(t.created_at)),1),e("td",null,l(z(t.size)),1),e("td",null,l(t.source_hostname)+" (v"+l(t.version)+")",1),e("td",null,[t.includes_database?(n(),i("span",Oe,"ğŸ—„ï¸")):b("",!0),t.includes_ssh_keys?(n(),i("span",je,"ğŸ”‘")):b("",!0),t.includes_certificates?(n(),i("span",qe,"ğŸ“œ")):b("",!0),t.includes_config?(n(),i("span",Pe,"âš™ï¸")):b("",!0)]),e("td",null,[e("button",{class:"btn btn-sm btn-primary",onClick:g=>R(t.filename)},"â¬‡ï¸",8,Ge),e("button",{class:"btn btn-sm btn-danger",onClick:g=>T(t.filename)},"ğŸ—‘ï¸",8,Ke)])]))),128))])]))])])]))}}),We=j(Je,[["__scopeId","data-v-46face6b"]]);export{We as default};
